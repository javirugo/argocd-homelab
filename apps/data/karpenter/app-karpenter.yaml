apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: karpenter
  namespace: argocd
spec:
  project: data
  source:
    chart: karpenter
    repoURL: https://charts.karpenter.sh/
    targetRevision: 0.16.3
    helm:
      releaseName: karpenter
      values: |
        controller:
          env:
            - name: AWS_REGION
              value: "us-fake-1"
            - name: AWS_ACCESS_KEY_ID
              value: "FAKEKEY"
            - name: AWS_SECRET_ACCESS_KEY
              value: "FAKESECRET"
            - name: AWS_EC2_METADATA_DISABLED
              value: "true"
        clusterName: "microk8s"
        clusterEndpoint: "https://192.168.100.2:16443"
        logLevel: "debug"
        serviceAccount:
          create: true
        settings:
          featureGates:
            Drift: false
  destination:
    server: "https://kubernetes.default.svc"
    namespace: data
  syncPolicy:
    automated: {}

# ---
# apiVersion: karpenter.sh/v1alpha5
# kind: Provisioner
# metadata:
#   name: kwok
#   namespace: data
# spec:
#   requirements:
#     - key: "kubernetes.io/arch"
#       operator: In
#       values: ["amd64"]
#     - key: "kubernetes.io/os"
#       operator: In
#       values: ["linux"]
#   limits:
#     resources:
#       cpu: 1000
#       memory: 1000Gi
#   providerRef:
#     name: kwok-provider

# ---
# apiVersion: karpenter.k8s.aws/v1alpha1
# kind: AWSNodeTemplate
# metadata:
#   name: kwok-provider
#   namespace: data
# spec:
#   subnetSelector: {}
#   securityGroupSelector: {}