apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik
  namespace: argocd
spec:
  project: build
  source:
    chart: traefik
    repoURL: https://traefik.github.io/charts
    targetRevision: 37.1.2
    helm:
      releaseName: traefik
      values: |
        # --- General ---
        deployment:
          enabled: true
          replicas: 1

        # --- EntryPoints (NodePorts for Gateway traffic) ---
        ports:
          web:
            port: 80
            nodePort: 30080
            expose: true
            exposedPort: 80
            protocol: TCP

          websecure:
            port: 443
            nodePort: 30443
            expose: true
            exposedPort: 443
            protocol: TCP

          # Dashboard (internal only, ClusterIP)
          traefik:
            port: 9000
            expose: true
            exposedPort: 9000
            protocol: TCP

        service:
          enabled: true
          type: NodePort
          spec:
            externalTrafficPolicy: Cluster
          ports:
            web:
              nodePort: 30080
            websecure:
              nodePort: 30443
            traefik:
              # dashboard, not exposed externally
              nodePort: null

        # --- Disable traditional Ingress providers ---
        providers:
          kubernetesIngress:
            enabled: false
          kubernetesCRD:
            enabled: false
          kubernetesGateway:
            enabled: true
            experimentalChannel: true  # Enable Gateway API controller

        # --- Enable Dashboard (internal only) ---
        dashboard:
          enabled: true
          domain: traefik.local
          service:
            type: ClusterIP
            annotations: {}
          ingressRoute: false  # do not expose dashboard via ingress

        # --- Logs ---
        logs:
          general:
            level: INFO
          access:
            enabled: true

        # --- Security ---
        pilot:
          enabled: false

        # Disable metrics, tracing, and other integrations
        metrics:
          prometheus:
            enabled: false
        tracing:
          enabled: false

        # --- Additional settings ---
        additionalArguments:
          # Only enable Gateway API support (no ingress)
          - "--providers.kubernetesgateway=true"
          - "--providers.kubernetescrd=false"
          - "--providers.kubernetesingress=false"
          # Keep dashboard local
          - "--api.dashboard=true"
          - "--entrypoints.web.address=:80"
          - "--entrypoints.websecure.address=:443"
          - "--entrypoints.traefik.address=:9000"
          - "--serversTransport.insecureSkipVerify=true"

  destination:
    server: "https://kubernetes.default.svc"
    namespace: build
  syncPolicy:
    automated: {}

