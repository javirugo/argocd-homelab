apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik
  namespace: argocd
spec:
  project: build
  source:
    chart: traefik
    repoURL: https://traefik.github.io/charts
    targetRevision: 37.1.2
    helm:
      releaseName: traefik
      values: |
        experimental:
          kubernetesGateway:
            enabled: true
        ports:
          web:
            port: 8000
            expose:
              default: true
            exposedPort: 80
            nodePort: 30080
            protocol: TCP
          websecure:
            port: 8443
            expose:
              default: true
            exposedPort: 443
            nodePort: 30443
            protocol: TCP
          traefik:
            port: 9000
            exposedPort: 9000
            protocol: TCP
        service:
          enabled: true
          type: NodePort
          spec:
            externalTrafficPolicy: Cluster
          ports:
            web:
              nodePort: 30080
            websecure:
              nodePort: 30443
        providers:
          kubernetesGateway:
            enabled: true
            experimentalChannel: true
          kubernetesIngress:
            enabled: false
          kubernetesCRD:
            enabled: false
        dashboard:
          enabled: true
          service:
            type: ClusterIP
          ingressRoute: false
        pilot:
          enabled: false
        metrics:
          prometheus:
            enabled: false
        additionalArguments:
          - "--providers.kubernetesgateway=true"
          - "--providers.kubernetesgateway.experimentalchannel=true"
          - "--providers.kubernetesGateway.experimentalChannel=true"
          - "--entrypoints.web.address=:8000"
          - "--entrypoints.websecure.address=:8443"
          - "--entrypoints.traefik.address=:9000"
          - "--api.dashboard=true"
          - "--api.insecure=true"
  destination:
    server: "https://kubernetes.default.svc"
    namespace: build
  syncPolicy:
    automated: {}

---
# ClusterIP Service for Traefik Dashboard
apiVersion: v1
kind: Service
metadata:
  name: traefik-dashboard
  namespace: build
  labels:
    app.kubernetes.io/name: traefik
spec:
  type: ClusterIP
  ports:
    - name: dashboard
      port: 9000
      targetPort: 9000
  selector:
    app.kubernetes.io/name: traefik

---
# Ingress for Traefik Dashboard
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    cert-manager.io/cluster-issuer: lets-encrypt
  labels:
    app: traefik
  name: traefik
  namespace: build
spec:
  ingressClassName: nginx
  rules:
  - host: traefik.galluman.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: traefik-dashboard
            port:
              name: dashboard
  tls:
  - hosts:
    - traefik.galluman.com
    secretName: traefik-ingress-tls
