apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik
  namespace: argocd
spec:
  project: build
  source:
    chart: traefik
    repoURL: https://traefik.github.io/charts
    targetRevision: 37.1.2
    helm:
      releaseName: traefik
      values: |
        # --- General ---
        deployment:
          enabled: true
          replicas: 1

        # --- Ports ---
        ports:
          web:
            port: 8000               # Must stay 8000 — internal default
            expose:
              default: true
            exposedPort: 80
            nodePort: 30080
            protocol: TCP

          websecure:
            port: 8443               # Must stay 8443 — internal default
            expose:
              default: true
            exposedPort: 443
            nodePort: 30443
            protocol: TCP

          traefik:
            port: 9000
            expose:
              default: true
            exposedPort: 9000
            protocol: TCP

        service:
          enabled: true
          type: NodePort
          spec:
            externalTrafficPolicy: Cluster
          ports:
            web:
              nodePort: 30080
            websecure:
              nodePort: 30443

        # --- Providers ---
        providers:
          kubernetesIngress:
            enabled: false
          kubernetesCRD:
            enabled: false
          kubernetesGateway:
            enabled: true
            experimentalChannel: true

        # --- Dashboard ---
        dashboard:
          enabled: true
          domain: traefik.local
          service:
            type: ClusterIP
          ingressRoute: false

        # --- Logs ---
        logs:
          general:
            level: INFO
          access:
            enabled: true

        # --- Disable Pilot & Metrics ---
        pilot:
          enabled: false

        metrics:
          prometheus:
            enabled: false

        # --- Arguments ---
        additionalArguments:
          - "--providers.kubernetesgateway=true"
          - "--entrypoints.web.address=:8000"
          - "--entrypoints.websecure.address=:8443"
          - "--entrypoints.traefik.address=:9000"
          - "--api.dashboard=true"

  destination:
    server: "https://kubernetes.default.svc"
    namespace: build
  syncPolicy:
    automated: {}

