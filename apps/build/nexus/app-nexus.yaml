apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nxrm-ha
  namespace: argocd
spec:
  project: build
  source:
    chart: nxrm-ha
    repoURL: https://sonatype.github.io/helm3-charts/
    targetRevision: 84.1.0
    helm:
      releaseName: nxrm-ha
      values: |
        namespaces:
          nexusNs:
            enabled: false
            name: build

        statefulset:
          replicaCount: 1
          clustered: false
          container:
            resources:
              requests:
                cpu: 4
                memory: 8Gi
              limits:
                cpu: 8
                memory: 16Gi
            # workaround to use Nexus CE (see https://github.com/sonatype/nxrm3-ha-repository/issues/125)
            additionalEnv:
              - name: INSTALL4J_ADD_VM_PARAMS
                value: "-Xms2703m -Xmx2703m -Dnexus.loadAsOSS=true -Dnexus.datastore.enabled=true -Djava.util.prefs.userRoot=${NEXUS_DATA}/javaprefs -Dnexus.datastore.nexus.jdbcUrl=jdbc:postgresql://${DB_HOST}:5432/${DB_NAME} -Dnexus.datastore.nexus.username=${DB_USER} -Dnexus.datastore.nexus.password=${DB_PASSWORD}"

        ingress:
          enabled: true
          host: nexus.galluman.com
          hostPath: /
          incressClassName: nginx
          annotations:
            cert-manager.io/cluster-issuer: lets-encrypt
            kubernetes.io/ingress.class: nginx
            nginx.ingress.kubernetes.io/proxy-body-size: 10g
          tls:
            - secretName: nexus-ingress-tls
              hosts:
              - nexus.galluman.com
              - docker.galluman.com
              - dockerproxy.galluman.com

        pvc:
          storage: 200Gi

        nexus:
          docker:
            enabled: true
            registries:
            - host: docker.galluman.com
              port: 5000
            - host: dockerproxy.galluman.com
              port: 5001
  destination:
    server: "https://kubernetes.default.svc"
    namespace: build
  syncPolicy:
    automated: {}
